# 14. 지역 특징점 검출과 매칭

## 14.1 코너 검출

### 코너와 특징점

영상에서 특징(feature)란 영상으로부터 추출할 수 있는 유용한 정보를 의미함
- 평균 밝기, 히스토그램, 에지, 직선 성분, 코너 등이 특징이 될 수 있음
- 영상의 특징 중에서 에지, 직선 성분, 코너처럼 영상 전체가 아닌 일부 영역에서 추출할 수 있는 특징을 지역 특징(local feature)이라고 함.

영상의 지역 특징 중 코너는 에지의 방향이 급격하게 변하는 부분

코너처럼 한 점의 형태로 표현할 수 있는 특징을 특징점이라고 함.

### 해리스 코너 검출

해리스가 개발한 코너 검출기의 기본적인 아이디어는 코너 점은 해당 위치에서 작은 크기의 윈도우를 움직였을 때 모든 방향에서 밝기의 변화가 크게 나타난다는 것이다.

해리스는 특정 위치(x,y)가 평탄한 영역인지 에지 영역인지 코너인지를 판단할 수 있는 코너 응답 함수(measure of corner response) R을 정립함.

### FAST 코너 검출

FAST(Features from Accelerated Segment Test) 방법은 각 픽셀을 둘러싸고 있는 16개의 주변 픽셀과 밝기 비교로 코너 여부를 판별함
- p점 주변 1번부터 16번 픽셀과의 밝기를 비교하여, 점 p의 밝기 보다 임계값 이상 충분히 밝거나 또는 충분히 어두운 픽셀이 아홉 개 이상 연속으로 존대하면 코너로 정의함

FAST 방법에서는 코너 점과 주변 16개 점과의 픽셀 값 차이 합을 코너 점수로 정의함

## 14.2 크기 불변 특징점 검출

코너는 회전 불변 특징점이나 크기 불변 특징점은 아님

크기 불변 특징점은 이미지의 크기 변화에 강인한(크게 영향 받지 않는) 특징점을 의미

ORB알고리즘은 FAST 코너 검출 방법을 이용하여 특징점을 추출함

- 기본적인 FAST알고리즘은 영상의 크기 변화에 취약하기 떄문에 ORB알고리즘은 입력 영상의 크기를 점진적으로 축소한 피라미드 영상을 구축하여 특징점을 추출함

각 특징점에서 주된 방향 성분을 계산하고, 방향을 고려한 BRIEF 알고리즘으로 이진 기술자를 계산함

- ORB 알고리즘에서는 기본적으로 256개의 크기 비교 픽셀 쌍을 사용하여 이진 기술자를 구성함. 즉 하나의 특징점은 256비트의 특징 벡터를 이룸

### OpenCV 특징점 검출

특징점을 검출할 때에는 Feature2D::detect() 함수를 사용함

이미 검출된 특징점에서 각 특징점 주변의 부분 영상을 표현하는 기술자를 추출하려면 
Feature2D::compute() 멤버 함수를 사용함

## 14.3 특징점 매칭

특징점 매칭(feature matching)은 두 영상에서 추출한 특징점 기술자를 비교하여 서로 비슷한 특징점을 찾는 작업을 의미함

특히 크기 불변 특징점으로부터 구한 기술자를 매칭하면 크기와 회전에 강인한 영상 매칭을 수행할 수 있음

### 특징점 매칭 방법

BFMatcher 클래스는 전수 조사(Bruteforce) 방식으로 특징점 매칭을 수행함

- 질의 기술자 집합에 있는 모든 기술자와 훈련 기술자 집합에 있는 모든 기술자 사이의 거리를 계산하고, 가장 거리가 작은 기술자를 찾아 매칭하는 방식임

FlannBasedMatcher 클래스는 Flann을 이용하여 빠르게 매칭을 수향

FlannBasedMatcher 클래스는 기본적으로 L2 노름 거리 측정 방식을 사용하기 떄문에 해밍 거리를 사용하는 이진 기술자에 대해서는 사용할 수 없음

DMatch 클래스는 특징점 매칭 정보를 저장할 때 사용하는 클래스

### 호모그래피와 영상 매칭

호모그래피는 3차원 공간상의 평면을 서로 다른 시점에서 바라봤을 때 획득되는 영상 사이의 변환 관계를 나타내는 용어임

연산 관점에서 호모그래피는 투시 변환과 같기 때문에 3 x 3 살수 행렬로 표현할 수 있음

일반적으로 특징점 매칭 결과로부터 호모그래피를 계산할 때 최소자승법을 사용하면 이상치(잘못 매칭되어 오차가 큰 입력 정보) 때문에 호모그래피가 제대로 계산되지 않음

RANSAC 또는 RHO 방법은 이상티가 50%이상 존재하더라도 호모그래피 행렬을 잘 찾는 편임


## 14.4 영상 이어 붙이기

영상 이어 붙이기는 여러 장의 영상을 서로 이어 붙여서 하나의 큰 영상을 만드는 기법임 

영상 이어 붙이기로 만들어진 영상을 파노라마 영상이라고 부름



[참고] 크기 불변 객체 검출 알고리즘(SIFT)

객체의 크기가 변경(확대, 축소) 되더라도, 하나의 객체를 지속적으로 동일한 객체로 검출할 수 있는 방법 중 대표적인 알고리즘이 SIFT임

피라미드 레이어에서 인접한 가우시안 블러링 영상끼리의 차영상을 구함

이를 DoG 영상이라고 함

특징점 기술자는 특징 벡터 라고도 함

Feature descriptor는 특징점 주변 pixel의 그래디언트 방향 히스토그램을 의미

SIFT 알고리즘은 객체 인식, 파노라마 영상 이어 붙이기, 3차원 장면 인식 등의 분야에서 효과적으로 사용되었으나, 계산이 복잡한 이슈가 있음

모두 스케일 스페이스를 구축해야 하는 등 복잡한 연산이 요구되어 실시간 응요에는 적응하기 곤란한 이슈가 있음